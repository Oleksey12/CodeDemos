;====================================================================
; Main.asm file generated by New Project wizard
;
; Created:   Пт дек 15 2023
; Processor: ATmega324P
; Compiler:  AVRASM (Proteus)
;====================================================================

;====================================================================
; DEFINITIONS
;====================================================================

;====================================================================
; VARIABLES
;====================================================================

;====================================================================
; RESET and INTERRUPT VECTORS
;====================================================================

 .ORG 0x00 
	jmp Start
 .ORG 0x24
	jmp INTER0

;====================================================================
; CODE SEGMENT
;====================================================================

.CSEG
.EQU data_high = 6
.EQU data_low = 4
.EQU command_high = 2
.EQU command_low = 0

Start:
     sei 
     
     LDI r18, 0b0000111
     LDI r17, 255
     OUT DDRB, r18
     OUT DDRA, r17
     
   image_show:
      ldi ZH, HIGH(capybara*2)
      ldi ZL, LOW(capybara*2)
     
      ldi r17, 7
      clr r18
      cycle2:
	; Clearing display RAM
	;rcall Clear_reset
	
	cpi r17, 8
	breq start_cycle
	
	; Selecting next line for drawing
	rcall Select_line
	ldi r20, 8
	add r18, r20 
	
	 start_cycle:
	   ldi r16, 128
	   cycle:   
	      ;Getting capybara data
	      lpm
	      mov r20, r0
	      rcall Write_to_display	   
	      ; Increase address
	      ldi r20, 1
	      clr r2
	      add ZL, r20
	      adc ZH, r2
	      
	      subi r16, 1
	      cpi r16, 0
	      brne cycle
	
	;rcall Wait_interrupt
	ldi r19, 41
	rcall Wait_for_ms
	
	subi r17, 1
	cpi r17, 0
	brne cycle2
   rjmp image_show
     

     Loop:
      rjmp  Loop
     
  

  
Write_to_display:
   ;Input r20
   ;Uses r18
   push r18
   LDI r18, data_high
   OUT PORTB, r18
   
   OUT PORTA, r20
   LDI r18, data_low
   OUT PORTB, r18
   
   pop r18
   reti

   
Clear_reset:
   ;uses r20
   push r20
   
   LDI r20, command_high
   OUT PORTB, r20
   ldi r20, 0b11100010
   OUT PORTA, r20
   LDI r20, command_low
   OUT PORTB, r20
   
   pop r20
   reti
   
Select_line:
   ;Input r18
   ;Uses r19
   push r19
   
   ldi r19, 0b01111000
   sub r19, r18
   
   OUT PORTA, r19
   LDI r19, command_high
   OUT PORTB, r19
   
   LDI r19, command_low
   OUT PORTB, r19
   
   pop r19
   reti
 
 
On_off_display:
   ;Input r18
   LDI r18, command_high
   OUT PORTB, r18
   ldi r18, 0b10101111
   OUT PORTA, r18
   SLEEP
   LDI r18, command_low
   OUT PORTB, r18
   reti

Wait_for_ms:
   ;input r19, r21
   ;uses r20
   push r20
   push r19
   lp2:
      mov r20, r21
      lp1:
	 dec r20
	 cpi r20, 0
	 brne lp1
      
      dec r19
      cpi r19, 0
      brne lp2
   pop r19
   pop r20
   reti

Wait_interrupt:
      ;input r21
      ;uses r22
      push r22
      
      ldi r22, 2
      STS TIMSK0, r20
      ldi r22, 0b0000101
      OUT TCCR0B, r20      
      ;ldi r19, 128
      ;OUT TCNT0, r19
      
      EOR r22, r22
      
   sleep_loop:
      cp r22, r21
      brne sleep_loop
      
      clr r22
      OUT TCCR0B, r20
      ldi r22, 0
      STS TIMSK0, r20
      
      pop r22
      reti

INTER0:
   inc r22
capybara: .db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 128, 128, 128, 127, 127, 127, 1, 1, 1, 15, 15, 15, 1, 1, 1, 113, 113, 113, 113, 113, 113, 1, 1, 1, 1, 1, 1, 14, 14, 14, 14, 14, 14, 142, 142, 142, 240, 240, 240, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 224, 224, 224, 31, 31, 31, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 255, 255, 255, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 192, 192, 192, 56, 56, 56, 7, 7, 7, 7, 7, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 192, 192, 192, 56, 56, 56, 56, 56, 56, 7, 7, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 255, 255, 255, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 240, 240, 240, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 128, 128, 128, 127, 127, 127, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 255, 255, 255, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 31, 31, 31, 224, 224, 224, 0, 0, 0, 0, 0, 0, 0, 0, 0, 255, 255, 255, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 7, 7, 7, 63, 63, 63, 56, 56, 56, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 248, 248, 248, 255, 255, 255, 248, 248, 248, 248, 248, 248, 255, 255, 255, 248, 248, 248, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
